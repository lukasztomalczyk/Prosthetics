@page "/export-excel"

@using System.Text
@using CommunityToolkit.Maui.Alerts
@using CommunityToolkit.Maui.Storage
@using MediatR
@using Prosthetics.Common
@using Prosthetics.Components.Layout
@using Prosthetics.Features.Admin

@inject IFileSaver _fileServer
@inject IExcelExporter _excelExporter
@inject IMediator _mediator
@inject IDateTime _dateTime
@inject NotificationService _notificationService

<RadzenLabel Text="Wybierz zakres generowane raportu:" Component="DatePickerHourFormat" Style="margin-right: 8px; vertical-align: middle;" />
od:
<RadzenDatePicker @bind-Value=@_from ShowTime="false" DateFormat="dd-MM-yyyy" Name="DatePickerHourFormat" />
do:
<RadzenDatePicker @bind-Value=@_to ShowTime="false" DateFormat="dd-MM-yyyy" Name="DatePickerHourFormat" />
<br />
<ButtonComponent Text="Pobierz raport" OnButtonClick="@GenerateReport"></ButtonComponent>

@code {
    private DateTime _from { get; set; }

    private DateTime _to { get; set; }

    protected override void OnInitialized()
    {
        var today = _dateTime.Now();
        _to = new DateTime(today.Year, today.Month, DateTime.DaysInMonth(today.Year, today.Month));
        _from = new DateTime(today.Year, today.Month, 1);
    }

    protected async Task GenerateReport()
    {
        var result = await _mediator.Send(new GetOrdersByDateRangeQuery()
        {
            From = _from,
            To = _to
        });
        _excelExporter.New();
        _excelExporter.AddWorksheet($"Raport_{_from.ToString("dd-MM-yyyy")}-{_to.ToString("dd-MM-yyyy")}");
        _excelExporter.SetData(_ =>
        {
            new ExcelDefinition(_, result).AddHeaders().AddRows();
        });
        await SaveFile();
    }

    protected async Task SaveFile()
    {
        using var stream = new MemoryStream();
        _excelExporter.SaveFile(stream);
        var fileSaverResult = await _fileServer.SaveAsync(
            $"Raport_{_from.ToString("dd-MM-yyyy")}-{_to.ToString("dd-MM-yyyy")}.xlsx", stream);
        fileSaverResult.EnsureSuccess();

        _notificationService.Notify(new NotificationMessage()
        {
            Severity = NotificationSeverity.Success,
                Summary = $"Plik zapisano: {fileSaverResult.FilePath}",
            Duration = 4000
        });
    }
}
